name: Pyre-fly Typecheck

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  typecheck:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install deps
        working-directory: py-libp2p
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pre-commit

      - name: Run typecheck
        working-directory: py-libp2p
        run: |
          set -eo pipefail
          make typecheck 2>&1 | tee typecheck.log || true
          # extract only lines starting with "ERROR "
          grep '^ERROR ' typecheck.log > errors_current.txt

      - name: Upload raw log
        uses: actions/upload-artifact@v2
        with:
          name: typecheck-log
          path: py-libp2p/typecheck.log

      - name: Compare errors, comment & fail on new
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const core = require('@actions/core');
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request.number;

            // Read current errors
            const current = fs.readFileSync('py-libp2p/errors_current.txt', 'utf8')
                              .trim().split('\n').filter(Boolean);

            // Fetch prior bot comments
            const { data: comments } = await github.issues.listComments({
              owner, repo, issue_number: pr
            });
            const typeComments = comments
              .filter(c => c.user.login === 'github-actions[bot]' && c.body.includes('**Typecheck report**'))
              .sort((a,b) => new Date(a.created_at) - new Date(b.created_at));

            let previous = [];
            if (typeComments.length) {
              // Extract the last Raw errors block
              const last = typeComments[typeComments.length - 1].body;
              const m = last.match(/```txt\n([\s\S]*?)\n```/);
              if (m) previous = m[1].split('\n').filter(Boolean);
            }

            // Diff
            const added = current.filter(e => !previous.includes(e));
            const removed = previous.filter(e => !current.includes(e));

            // Build comment
            const lines = [
              "**Typecheck report**",
              `- Total errors: **${current.length}**`
            ];

            if (typeComments.length) {
              if (removed.length) {
                lines.push(`\nðŸŽ‰ **Fixed ${removed.length} error(s):**`);
                lines.push("```diff");
                removed.forEach(e => lines.push(`- ${e}`));
                lines.push("```");
              }
              if (added.length) {
                lines.push(`\nðŸš¨ **Introduced ${added.length} new error(s):**`);
                lines.push("```diff");
                added.forEach(e => lines.push(`+ ${e}`));
                lines.push("```");
              }
            }

            // Always include full raw list for next diff
            lines.push("\n### Raw errors");
            lines.push("```txt");
            current.forEach(e => lines.push(e));
            lines.push("```");

            // Post the comment
            await github.issues.createComment({
              owner, repo, issue_number: pr,
              body: lines.join("\n")
            });

            // Fail if any new errors were introduced
            if (added.length) {
              core.setFailed(`New type errors introduced: ${added.length}`);
            }
